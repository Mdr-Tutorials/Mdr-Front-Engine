# Route Manifest 与 Outlet 渲染链

## 状态

- Draft
- 日期：2026-02-08

## 决策背景

当前 Blueprint 中的路由地址是预览层状态：

- 地址栏数据来自 `routes/currentPath` 本地 state
- 内部跳转 `navigate` 只更新 `currentPath`
- 并未形成项目级可持久化路由结构

这导致：

1. 路由无法映射到具体文档
2. 无法表达布局路由与 `Outlet`
3. 子路由结构不可复用、不可导出

## 决策内容

采用 **Route Manifest** 作为唯一路由定义来源，并引入布局文档 + Outlet 规则。

1. 路由定义不再依赖纯字符串列表
2. 路由节点可引用 `layoutDocId` 与 `pageDocId`
3. 子路由渲染通过 Outlet 串联
4. 运行时能力（loader/guard/error/seo）走 Route Runtime 扩展（见 ADR 13）

## 路由节点（摘要）

```ts
type RouteNode = {
    id: string;
    segment?: string; // "product" | ":id" | "*"
    index?: boolean;
    layoutDocId?: string;
    pageDocId?: string;
    children?: RouteNode[];
};
```

## Outlet 规则

1. 当 `RouteNode` 有 `children` 时，其 `layoutDocId` 对应文档必须包含 Outlet 占位
2. 若缺失 Outlet，编辑器给出结构诊断并阻止发布
3. `index=true` 子节点不允许声明 `segment`

## 解耦原则

**路由拆分方式与 VFS 拆分方式不可强绑定**：

1. 一个路由可由多文档组合（layout + page）
2. 一个文档可在不同路由被复用（受策略控制）
3. 文件路径仅用于存储与组织，不直接决定运行时匹配语义

## 迁移策略

1. 旧地址栏列表在首次迁移时转为平铺 `RouteNode[]`
2. 默认生成 `root-layout` 并注入 Outlet
3. `currentPath` 仅保留为“预览选中路径”，不再是路由源数据

## 风险与缓解

1. **风险：用户不理解 layout/page 拆分**
    - 缓解：创建路由向导与模板
2. **风险：Outlet 概念引入学习成本**
    - 缓解：在可视化树中直接标注“子路由插槽”
3. **风险：历史项目迁移失败**
    - 缓解：提供自动修复与回退备份

## 验收标准（Draft）

- [ ] 支持 `/`, `/product/:id`, `/settings/profile` 多级路由
- [ ] 支持 layout + child + index 组合渲染
- [ ] Outlet 缺失可被检测并提示
- [ ] 路由清单可序列化保存并导出
