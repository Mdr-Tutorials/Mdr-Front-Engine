# 统一 Command History（跨 MIR 与非 MIR）

## 状态

- Draft
- 日期：2026-02-08

## 决策背景

当前编辑器修改路径以“直接改 `mirDoc`”为主，尚未形成统一历史抽象：

- Blueprint 的增删改查通过 `updateMirDoc` 直接变更：`apps/web/src/editor/features/design/BlueprintEditor.tsx`
- Inspector 也直接修改节点树：`apps/web/src/editor/features/design/BlueprintEditorInspector.tsx`
- 尚无跨文档、跨编辑器（Blueprint/NodeGraph/VFS）的历史栈

未来需求包括：

1. Node Graph 画布位置与连线调整（可能不写入 MIR）
2. 文件树重命名、移动、删除
3. 多文档并行编辑

如果历史系统只围绕 MIR，将在第二阶段失效。

## 决策内容

采用 **Command + Transaction** 历史模型，覆盖所有可逆操作：

1. 每次用户操作封装为 `Command`
2. `Command` 以可序列化操作描述存储（不存闭包）
3. 可将多个 `Command` 合并为一个事务（如一次拖拽）
4. 历史作用域以 `target.workspaceId + target.documentId + namespace` 标识
5. `workspace` 域命令统一映射为 `core.workspace.*` 命名空间（系统内部触发）
6. Envelope required 字段与 `specs/decisions/12.intent-command-extension.md`（API-002）保持一致

## 核心接口（对齐 API-002）

```ts
type CommandDomainHint = 'mir' | 'workspace' | string;

interface Command {
    // API-002 required fields（冻结）
    id: string;
    namespace: string;
    type: string;
    version: string;
    issuedAt: string;
    forwardOps: Array<PatchOp>;
    reverseOps: Array<PatchOp>;
    target: {
        workspaceId: string;
        documentId?: string;
    };

    // Local optional fields（允许扩展）
    mergeKey?: string;
    label?: string;
    domainHint?: CommandDomainHint;
}
```

其中 required 字段不得删改；如需扩展仅允许新增可选字段，且不得改变回放语义。

执行器职责：

1. 解析 `forwardOps/reverseOps`
2. 按 `namespace` 路由到对应执行域并应用 patch
3. 维护事务边界与失败回滚

## 关键规则

1. `forwardOps` 成功应用后才入历史栈
2. Undo/Redo 仅操作已提交命令，不直接访问 UI 临时态
3. 高频拖拽可按 `mergeKey` 合并为单条历史
4. 文档级命令必须带 `target.documentId`；workspace 级命令可省略
5. 命令只保存“最小可逆差异”，避免整文档快照爆内存
6. `label/domainHint` 仅用于展示与诊断，不参与可逆语义

## 方案边界

### 本阶段纳入历史

- MIR 节点增删改
- 内部文档树操作（由路由/布局编辑触发，不直接暴露给用户）

### 预留但不实现（本轮）

- NodeGraph 节点位置、连线（仅协议预留，不实现编辑器能力）
- 动画编辑器时间轴操作（仅协议预留，不实现编辑器能力）

### 本阶段不纳入历史

- 纯视觉临时态（hover、右键菜单开关）
- 网络请求中间状态

## 迁移策略

1. 在 workspace store 直接引入 `applyCommand` 作为唯一变更入口
2. 先落地 `core.mir.*` 与 `core.workspace.*` 命令；nodegraph/动画命令留作后续里程碑
3. 在每个编辑器入口提供统一快捷键：
    - `Ctrl/Cmd+Z` -> undo
    - `Ctrl/Cmd+Shift+Z` -> redo

## 风险与缓解

1. **风险：命令对象过多导致内存增长**
    - 缓解：限制历史深度（默认 100~200），并做 merge
2. **风险：异步命令撤销不一致**
    - 缓解：本地命令先同步落地；远端同步由 outbox 独立处理
3. **风险：跨文档命令可见性复杂**
    - 缓解：文档级历史项强制带 `target.documentId`；workspace 级在 UI 标注为全局作用域

## 验收标准（Draft）

- [ ] Blueprint 场景的撤销/重做行为一致
- [ ] 文件树操作可撤销
- [ ] 同一拖拽只生成一条历史（或按配置合并）
- [ ] NodeGraph/动画域仅做协议预留且不阻塞当前实现
