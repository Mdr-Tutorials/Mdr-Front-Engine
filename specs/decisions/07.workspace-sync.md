# Workspace 同步协议（文档级 + rev）

## 状态

- In Progress
- 日期：2026-02-08

## 最新进展（2026-02-08）

已完成的第一阶段落地：

1. **后端 workspace 自愈与首建**
   - 新建项目时会同步创建 workspace 快照（workspaceId 与 projectId 对齐，默认写入 `doc_root`）。
   - `GET /api/workspaces/:id` 与 `GET /api/workspaces/:id/capabilities` 在发现 legacy project 且 workspace 缺失时会自动补建。
2. **前端保存链路切换**
   - Blueprint 编辑器优先走文档级保存（`PUT /api/workspaces/:id/documents/:docId`）。
   - 能力协商未就绪时暂停保存；能力明确不支持时回退到项目级保存（过渡兼容）。
3. **可视化反馈与 i18n**
   - 地址栏右侧增加紧凑保存状态图标（saving/saved/error/fallback）。
   - 保存成功状态短暂显示后自动回到 idle；中英文文案已补齐。
4. **测试与结构**
   - 补充了 autosave、store、workspace handler 相关测试。
   - Blueprint 主文件已拆分为 controller/autosave/dragdrop/tree/palette/save-indicator 模块。

## 决策背景

当前保存链路是“整份 MIR 覆盖保存”：

- 前端 `saveProjectMir(token, projectId, mir)`：`apps/web/src/editor/editorApi.ts`
- 700ms 防抖触发保存：`apps/web/src/editor/features/design/BlueprintEditor.tsx`
- 后端 `SaveMIR` 更新 `projects.mir_json`：`apps/backend/project_store.go`

该模式在单文档阶段可用，但不适合：

1. 多文档工作区
2. 文件树操作与文档内容分离保存
3. 并发冲突检测

## 决策内容

采用 **文档级同步 + 分区 rev 乐观并发**：

1. 每个文档独立保存（`docId + content + expectedContentRev`）
2. 工作区结构与路由使用 `workspaceRev/routeRev` 并发控制
3. 后端基于分区 rev 校验并返回最新 rev 集合
4. 发生冲突返回 409，客户端拉取后重放本地 pending 操作

## 同步模型

### 客户端

- 即时本地应用（保证交互流畅）
- 将操作写入 outbox
- 定时批量 flush（500~800ms）

### 服务端

- 对每个写请求进行分区基线校验（`expectedContentRev/expectedWorkspaceRev/expectedRouteRev`）
- 成功后返回 `workspaceRev/routeRev/updatedDocuments/opSeq`
- 冲突返回服务端当前快照摘要

## 为什么现在不选 CRDT

1. 当前为单人编辑优先，协同不是第一优先级
2. CRDT 引入调试成本与心智负担较大
3. rev 模式可覆盖 90% 近期需求，并可作为 CRDT 前置层

## API 范围（Draft）

1. `GET /api/workspaces/:id`
2. `GET /api/workspaces/:id/capabilities`
3. `PUT /api/workspaces/:id/documents/:docId`
4. `POST /api/workspaces/:id/intents`
5. `POST /api/workspaces/:id/batch`
6. capabilities 可提前声明保留域（如 `core.nodegraph.*`、`core.animation.*`）为 `false`

详见：`specs/api/workspace-sync.openapi.yaml`

## 迁移策略（更新）

1. 分阶段切换：默认文档级保存，保留能力开关控制的项目级回退路径（仅过渡期）。
2. 老项目通过“读取即补建”的方式自动转为 workspace 快照，并保留离线迁移脚本方案。
3. 在迁移窗口结束后移除 `PUT /projects/:id/mir` 回退路径，收敛为 workspace-only。

## 风险与缓解

1. **风险：频繁保存带来接口压力**
   - 缓解：前端防抖 + batch 接口 + 后端幂等
2. **风险：冲突处理导致用户困惑**
   - 缓解：冲突提示包含文档路径、时间、用户动作摘要
3. **风险：双写期间数据不一致**
   - 缓解：不做双写，采用切换窗口 + 数据迁移 + 回滚备份

## 验收标准（阶段）

- [x] 文档级保存可在能力开启时生效，并更新对应文档 rev
- [x] 能力未就绪/不支持时可安全回退，不阻塞编辑
- [ ] 文件树操作可独立保存
- [ ] 冲突可检测并给出可恢复路径
- [ ] 迁移窗口结束后移除项目级回退写入路径
- [ ] 单项目 30 次/分钟编辑保存无明显卡顿
