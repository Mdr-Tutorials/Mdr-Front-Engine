# Workspace 同步协议（文档级 + rev）

## 状态

- Draft
- 日期：2026-02-08

## 决策背景

当前保存链路是“整份 MIR 覆盖保存”：

- 前端 `saveProjectMir(token, projectId, mir)`：`apps/web/src/editor/editorApi.ts`
- 700ms 防抖触发保存：`apps/web/src/editor/features/design/BlueprintEditor.tsx`
- 后端 `SaveMIR` 更新 `projects.mir_json`：`apps/backend/project_store.go`

该模式在单文档阶段可用，但不适合：

1. 多文档工作区
2. 文件树操作与文档内容分离保存
3. 并发冲突检测

## 决策内容

采用 **文档级同步 + 分区 rev 乐观并发**：

1. 每个文档独立保存（`docId + content + expectedContentRev`）
2. 工作区结构与路由使用 `workspaceRev/routeRev` 并发控制
3. 后端基于分区 rev 校验并返回最新 rev 集合
4. 发生冲突返回 409，客户端拉取后重放本地 pending 操作

## 同步模型

### 客户端

- 即时本地应用（保证交互流畅）
- 将操作写入 outbox
- 定时批量 flush（500~800ms）

### 服务端

- 对每个写请求进行分区基线校验（`expectedContentRev/expectedWorkspaceRev/expectedRouteRev`）
- 成功后返回 `workspaceRev/routeRev/updatedDocuments/opSeq`
- 冲突返回服务端当前快照摘要

## 为什么现在不选 CRDT

1. 当前为单人编辑优先，协同不是第一优先级
2. CRDT 引入调试成本与心智负担较大
3. rev 模式可覆盖 90% 近期需求，并可作为 CRDT 前置层

## API 范围（Draft）

1. `GET /api/workspaces/:id`
2. `GET /api/workspaces/:id/capabilities`
3. `PUT /api/workspaces/:id/documents/:docId`
4. `POST /api/workspaces/:id/intents`
5. `POST /api/workspaces/:id/batch`
6. capabilities 可提前声明保留域（如 `core.nodegraph.*`、`core.animation.*`）为 `false`

详见：`specs/api/workspace-sync.openapi.yaml`

## 迁移策略

1. 采用全量切换，不保留旧 `PUT /projects/:id/mir` 写入路径
2. 老项目通过一次性迁移脚本转为 workspace 快照
3. 前端仅保留 workspace API 客户端，不再发送单 `mir` 保存请求

## 风险与缓解

1. **风险：频繁保存带来接口压力**
   - 缓解：前端防抖 + batch 接口 + 后端幂等
2. **风险：冲突处理导致用户困惑**
   - 缓解：冲突提示包含文档路径、时间、用户动作摘要
3. **风险：双写期间数据不一致**
   - 缓解：不做双写，采用切换窗口 + 数据迁移 + 回滚备份

## 验收标准（Draft）

- [ ] 多文档下保存仅影响对应文档
- [ ] 文件树操作可独立保存
- [ ] 冲突可检测并给出可恢复路径
- [ ] 单项目 30 次/分钟编辑保存无明显卡顿
