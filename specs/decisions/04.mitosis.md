# 使用 Mitosis 进行多框架组件源码生成

## 决策背景

在 MDR Front Engine 项目中，我们需要支持多框架的组件生成，包括 React、Vue、Angular 等主流前端框架。手动维护多套组件代码会导致以下问题：

1. **代码重复** - 相同逻辑的组件需要在不同框架中重复实现
2. **维护困难** - 修改一个功能需要在多个框架代码中同步更新
3. **一致性差** - 不同框架的实现可能存在差异
4. **开发效率低** - 需要熟悉多个框架的开发模式

经过调研，我们考虑使用 **Mitosis** 作为跨框架组件源码生成解决方案。

## 候选方案分析

### 1. Mitosis

**优势：**

- 专门用于跨框架组件生成
- 支持 React、Vue、Angular、Svelte 等主流框架
- JSX-like 语法，学习成本低
- 活跃的社区和持续的开发
- Builder.io 背书，可靠性高

**劣势：**

- 相对较新，生态系统还在完善
- 某些高级特性支持有限
- 需要适应其特定的开发模式

### 2. Stencil

**优势：**

- 成熟的 Web Components 解决方案
- 良好的浏览器兼容性
- Ionic 团队开发，质量可靠

**劣势：**

- 主要专注于 Web Components
- 框架集成复杂度较高
- 包体积相对较大

### 3. 自建转码器

**优势：**

- 完全定制化
- 可以精确控制生成逻辑

**劣势：**

- 开发成本极高
- 维护负担重
- 需要处理复杂的 AST 转换

## Mitosis 技术方案

### 核心概念

Mitosis 使用一种中间语言（类似 JSX）来描述组件，然后编译生成不同框架的代码：

```typescript
// Mitosis 组件定义（.lite.tsx）
import { useState, useEffect } from '@builder.io/mitosis';

export interface ButtonProps {
  text?: string;
  variant?: 'primary' | 'secondary' | 'danger';
  size?: 'small' | 'medium' | 'large';
  disabled?: boolean;
  onClick?: (event: Event) => void;
}

export default function Button(props: ButtonProps) {
  const [isHovered, setIsHovered] = useState(false);

  return (
    <button
      class={`btn btn-${props.variant} btn-${props.size} ${isHovered ? 'hovered' : ''}`}
      disabled={props.disabled}
      onClick={(event) => props.onClick?.(event)}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      {props.text}
    </button>
  );
}
```

### 编译输出

Mitosis 会将上述组件编译成不同框架的代码：

#### React 输出

```typescript
import React, { useState } from 'react';

export interface ButtonProps {
  text?: string;
  variant?: 'primary' | 'secondary' | 'danger';
  size?: 'small' | 'medium' | 'large';
  disabled?: boolean;
  onClick?: (event: Event) => void;
}

export default function Button(props: ButtonProps) {
  const [isHovered, setIsHovered] = useState(false);

  return (
    <button
      className={`btn btn-${props.variant} btn-${props.size} ${isHovered ? 'hovered' : ''}`}
      disabled={props.disabled}
      onClick={(event) => props.onClick?.(event)}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      {props.text}
    </button>
  );
}
```

#### Vue 输出

```vue
<template>
    <button
        :class="`btn btn-${variant} btn-${size} ${isHovered ? 'hovered' : ''}`"
        :disabled="disabled"
        @click="onClick"
        @mouseenter="isHovered = true"
        @mouseleave="isHovered = false"
    >
        {{ text }}
    </button>
</template>

<script setup>
import { ref } from 'vue';

const props = defineProps({
    text: String,
    variant: String,
    size: String,
    disabled: Boolean,
    onClick: Function,
});

const isHovered = ref(false);
</script>
```

### 项目架构设计

#### 1. 组件库结构

```
packages/
├── mitosis-components/          # Mitosis 源组件
│   ├── src/
│   │   ├── components/         # 基础组件
│   │   │   ├── Button/
│   │   │   │   ├── Button.lite.tsx
│   │   │   │   ├── Button.types.ts
│   │   │   │   └── Button.stories.lite.tsx
│   │   │   ├── Input/
│   │   │   ├── Card/
│   │   │   └── ...
│   │   ├── hooks/             # 自定义 Hooks
│   │   ├── utils/             # 工具函数
│   │   └── styles/            # 样式系统
│   ├── mitosis.config.js      # Mitosis 配置
│   └── package.json
├── generated-react/           # 生成的 React 组件
├── generated-vue/             # 生成的 Vue 组件
├── generated-angular/         # 生成的 Angular 组件
└── generated-svelte/          # 生成的 Svelte 组件
```

#### 2. 构建流程

```typescript
// mitosis.config.js
module.exports = {
    files: 'src/**/*.lite.tsx',
    targets: ['react', 'vue', 'angular', 'svelte'],
    dest: '../generated',
    options: {
        react: {
            format: 'tsx',
            stateType: 'useState',
            stylesType: 'styled-components',
        },
        vue: {
            format: 'vue',
            api: 'composition',
            version: 3,
        },
        angular: {
            format: 'ts',
            style: 'scss',
        },
    },
    plugins: [
        // 自定义插件
        '@builder.io/mitosis-plugin-css-modules',
        '@builder.io/mitosis-plugin-i18n',
    ],
};
```

#### 3. 样式系统

```typescript
// 使用 CSS 变量实现主题系统
export const ThemeProvider = (props) => {
  return (
    <div
      class="theme-provider"
      style={{
        '--primary-color': props.theme.primary,
        '--secondary-color': props.theme.secondary,
        '--border-radius': props.theme.borderRadius,
        '--spacing-unit': props.theme.spacing
      }}
    >
      {props.children}
    </div>
  );
};

// 组件中使用
export const Card = (props) => {
  return (
    <div
      class="card"
      style={{
        backgroundColor: 'var(--primary-color)',
        borderRadius: 'var(--border-radius)',
        padding: 'calc(var(--spacing-unit) * 2)'
      }}
    >
      {props.children}
    </div>
  );
};
```

### 高级特性实现

#### 1. 条件渲染

```typescript
export const ConditionalList = (props) => {
  const [showItems, setShowItems] = useState(true);

  return (
    <div>
      <button onClick={() => setShowItems(!showItems)}>
        Toggle List
      </button>

      {showItems && (
        <ul>
          {props.items?.map((item) => (
            <li key={item.id}>{item.name}</li>
          ))}
        </ul>
      )}

      {!props.items?.length && <p>No items found</p>}
    </div>
  );
};
```

#### 2. 循环和列表

```typescript
export const TodoList = (props) => {
  const [todos, setTodos] = useState([
    { id: 1, text: 'Learn Mitosis', done: false },
    { id: 2, text: 'Build components', done: false }
  ]);

  return (
    <div>
      {todos.map((todo) => (
        <div key={todo.id} class="todo-item">
          <input
            type="checkbox"
            checked={todo.done}
            onChange={(e) => {
              setTodos(todos.map(t =>
                t.id === todo.id ? { ...t, done: e.target.checked } : t
              ));
            }}
          />
          <span class={todo.done ? 'done' : ''}>{todo.text}</span>
        </div>
      ))}
    </div>
  );
};
```

#### 3. 事件处理

```typescript
export const Form = (props) => {
  const [formData, setFormData] = useState({ name: '', email: '' });

  const handleSubmit = (event) => {
    event.preventDefault();
    props.onSubmit?.(formData);
  };

  return (
    <form onSubmit={handleSubmit}>
      <input
        value={formData.name}
        onInput={(event) =>
          setFormData({ ...formData, name: event.target.value })
        }
        placeholder="Name"
      />
      <input
        value={formData.email}
        onInput={(event) =>
          setFormData({ ...formData, email: event.target.value })
        }
        placeholder="Email"
        type="email"
      />
      <button type="submit">Submit</button>
    </form>
  );
};
```

### 开发工作流

#### 1. 组件开发规范

```typescript
// 文件命名规范
ComponentName/
├── ComponentName.lite.tsx      # Mitosis 组件源码
├── ComponentName.types.ts      # TypeScript 类型定义
├── ComponentName.module.scss   # 组件样式
├── ComponentName.stories.lite.tsx # Storybook 故事
├── ComponentName.test.ts       # 单元测试
└── index.ts                    # 导出文件
```

#### 2. 开发脚本

```json
{
    "scripts": {
        "dev": "mitosis build --watch",
        "build": "mitosis build",
        "build:react": "mitosis build --target=react",
        "build:vue": "mitosis build --target=vue",
        "build:angular": "mitosis build --target=angular",
        "test": "jest",
        "lint": "eslint src/**/*.lite.tsx",
        "storybook": "start-storybook -p 6006",
        "build-storybook": "build-storybook"
    }
}
```

#### 3. 持续集成

```yaml
# .github/workflows/build.yml
name: Build Components

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

jobs:
    build:
        runs-on: ubuntu-latest

        strategy:
            matrix:
                target: [react, vue, angular, svelte]

        steps:
            - uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '18'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Build components
              run: npm run build:${{ matrix.target }}

            - name: Run tests
              run: npm test

            - name: Upload artifacts
              uses: actions/upload-artifact@v3
              with:
                  name: ${{ matrix.target }}-components
                  path: packages/generated-${{ matrix.target }}
```

### 质量保证

#### 1. 类型安全

```typescript
// 严格的类型定义
export interface ComponentProps {
    // 必需属性
    title: string;

    // 可选属性
    variant?: 'primary' | 'secondary';

    // 默认值
    size?: 'small' | 'medium' | 'large';

    // 事件处理
    onClick?: (event: Event) => void;

    // 子组件
    children?: any;
}
```

#### 2. 测试策略

```typescript
// 跨框架测试
import { testComponent } from '@builder.io/mitosis-testing';

test('Button component', () => {
    const props = {
        text: 'Click me',
        onClick: jest.fn(),
    };

    const result = testComponent(Button, props);

    // 测试渲染结果
    expect(result.textContent).toBe('Click me');

    // 测试事件处理
    result.fireEvent('click');
    expect(props.onClick).toHaveBeenCalled();

    // 测试不同框架输出
    ['react', 'vue', 'angular'].forEach((target) => {
        const output = result.compile(target);
        expect(output).toMatchSnapshot();
    });
});
```

#### 3. 文档生成

````typescript
// 自动生成文档
/**
 * Button component for user interactions
 *
 * @example
 * ```tsx
 * <Button
 *   text="Click me"
 *   variant="primary"
 *   onClick={() => console.log('clicked')}
 * />
 * ```
 *
 * @param props - Button properties
 * @returns Button element
 */
export default function Button(props: ButtonProps) {
    // ... implementation
}
````

## 决策结论

选择 **Mitosis** 作为跨框架组件生成方案，基于以下原因：

### ✅ 核心优势

1. **专业性强** - 专门为跨框架组件生成设计
2. **学习成本低** - JSX-like 语法，易于上手
3. **框架支持全面** - 覆盖主流前端框架
4. **社区活跃** - Builder.io 团队维护，生态完善
5. **可扩展性好** - 支持自定义插件和配置

### ⚠️ 注意事项

1. **新技术的风险** - 需要关注版本更新和 API 变化
2. **高级特性限制** - 某些框架特定功能需要额外处理
3. **构建复杂度** - 需要维护多目标构建流程
4. **调试困难** - 跨框架调试相对复杂

## 实施计划

### 第一阶段：基础搭建（2-3 周）

- [ ] 项目结构设计和初始化
- [ ] Mitosis 配置和构建脚本
- [ ] 基础组件开发（Button、Input、Card 等）
- [ ] 样式系统设计

### 第二阶段：核心功能（3-4 周）

- [ ] 复杂组件开发（Form、Table、Modal 等）
- [ ] 主题系统集成
- [ ] 测试框架搭建
- [ ] 文档生成工具

### 第三阶段：高级特性（2-3 周）

- [ ] 动画和交互效果
- [ ] 国际化支持
- [ ] 无障碍访问
- [ ] 性能优化

### 第四阶段：集成完善（2 周）

- [ ] 与现有项目集成
- [ ] 持续集成部署
- [ ] 开发者工具
- [ ] 使用指南和最佳实践

## 预期收益

1. **开发效率提升 60%** - 一次编写，多框架使用
2. **维护成本降低 80%** - 单一代码库维护
3. **一致性保证** - 跨框架行为统一
4. **快速原型** - 快速验证不同框架实现
5. **技术债务减少** - 避免重复代码和逻辑分歧

## 参考资料

- [Mitosis 官方文档](https://github.com/BuilderIO/mitosis)
- [Builder.io 博客](https://www.builder.io/blog)
- [跨框架组件设计](https://www.smashingmagazine.com/2021/07/cross-framework-component-libraries/)
- [组件驱动开发](https://www.componentdriven.org/)
