# 布局范式与内置组件 Inspector Schema 决策

## 状态

- Draft
- 日期：2026-02-17
- 执行清单：
  - `specs/implementation/layout-pattern-and-builtin-inspector-task-backlog.md`

## 决策背景

当前 Blueprint 的布局能力主要由 `MdrDiv` + 手工拖拽组合完成，存在三个问题：

1. 缺少可复用的“预定义布局范式”，复杂页面骨架搭建成本高。
2. 内置组件 Inspector 仍以手写面板为主（例如 `LayoutPanel`），扩展成本高、重复逻辑多。
3. 外部组件已支持基于 d.ts 的调节项推断，但内置组件尚未形成统一元数据协议，能力不对称。

## 当前进展（2026-02-17）

1. Gate A 已落地：`LayoutPatternDefinition` 与参数 DSL 类型完成。
2. Gate A 已落地：`data-layout-*` 语义键、root/version 约束与 helper 完成。
3. Gate A 已落地：BuiltIn Inspector Schema 类型与 metadata 优先级策略完成。
4. Gate B 已落地：布局范式 registry + 首批 preset + Palette 插入链路完成。
5. Gate C 已落地：`LayoutPatternPanel`、Inspector 注册、参数回写链路与选中回退策略完成。

## 目标

1. 建立 Layout Pattern（布局范式）体系，支持一键插入页面骨架。
2. 建立 BuiltIn Inspector Schema（内置组件调节项协议），让内置组件调节项可配置、可扩展。
3. 与现有 Blueprint / MIR / Inspector 架构兼容，按阶段迁移，避免破坏现网流程。

## 决策内容

### 1) 采用“原语 + 范式 + 模板”三层结构

- 原语层：保留 `MdrDiv`/`MdrSection`/`MdrCard`/`MdrPanel` 作为基础布局组件。
- 范式层：新增参数化布局范式（如 `Split`, `HolyGrail`, `DashboardShell`）。
- 模板层：在范式上叠加业务组件，形成可复用页面模板。

### 2) 布局范式以“参数化 MIR 子树”实现

- 每个范式提供 `build(params)` 生成节点树，以及 `update(root, patch)` 用于 Inspector 联动回写。
- 生成节点仍是普通 `ComponentNode`，不新增 MIR 顶层结构。

### 3) 使用 dataAttributes 记录范式语义

范式相关元信息写入节点 `props.dataAttributes`：

- `data-layout-pattern`: 范式 ID（例如 `split`, `holy-grail`）
- `data-layout-pattern-root`: `"true"`（仅根节点）
- `data-layout-role`: 语义角色（`header|sidebar|main|footer|left|right`）
- `data-layout-version`: 版本号（用于后续迁移）

### 4) 内置组件采用 Schema 驱动 Inspector

- 新增 BuiltIn Meta Store，记录 `runtimeType -> defaultProps / propOptions / propsSchema / inspectorControls`。
- 内置组件调节项优先级：
  - 组件手工 override > 代码生成结果 > 通用推断
- 保留现有手写面板作为迁移期 fallback。

### 5) 统一 Inspector 渲染入口

- 保留 `INSPECTOR_PANELS` 机制。
- 新增 `LayoutPatternPanel`（只对 `data-layout-pattern-root` 生效）。
- 将通用 props 调节 UI 从外部组件能力抽象成可复用渲染器，供内置/外部共用。

## 标准调用链路

`Palette(Layout Patterns) -> createNodeFromPaletteItem -> LayoutPatternRegistry.build -> MIR Node Tree(with dataAttributes) -> Inspector(LayoutPatternPanel/BuiltInPropsPanel) -> LayoutPatternRegistry.update -> updateMirDoc`

约束：

1. 范式节点插入后仍是普通组件树，支持常规拖拽与编辑。
2. 范式参数回写必须走 `updateMirDoc`，确保历史/保存链路一致。
3. 不引入新的运行时渲染分支，继续复用 `@mdr/ui` + registry 体系。

## 分阶段改造清单

### Phase 0：基线与协议定义

- [x] 新增 `layoutPattern.types.ts`：定义 `LayoutPatternDefinition`、参数类型、update 协议。
- [x] 新增 `builtInMeta.types.ts`：定义内置 Inspector Schema 类型。
- [x] 明确 dataAttributes 约束（值统一字符串，避免类型分歧）。
- [x] 补充 ADR 附录中的命名规范（pattern id、role、version）。

主要文件：

- `apps/web/src/editor/features/design/blueprint/layoutPatterns/layoutPattern.types.ts`（新增）
- `apps/web/src/editor/features/design/inspector/meta/builtInMeta.types.ts`（新增）

---

### Phase 1：布局范式注册与 Palette 插入

- [x] 新增 `LayoutPatternRegistry`（register/get/list）。
- [x] 实现首批范式（建议：`split`, `holy-grail`, `dashboard-shell`）。
- [x] 在组件库左侧新增“布局范式”分组（与现有 layout 组并存）。
- [x] `createNodeFromPaletteItem` 支持 pattern item，调用 `build(params)` 生成节点。

主要文件：

- `apps/web/src/editor/features/design/blueprint/layoutPatterns/registry.ts`（新增）
- `apps/web/src/editor/features/design/blueprint/layoutPatterns/presets/*.ts`（新增）
- `apps/web/src/editor/features/design/blueprint/data/groups/LayoutPatternGroup.tsx`（新增）
- `apps/web/src/editor/features/design/blueprint/data/ComponentGroups.tsx`（修改）
- `apps/web/src/editor/features/design/BlueprintEditor.palette.ts`（修改）

---

### Phase 2：范式参数面板（LayoutPatternPanel）

- [x] 新增 `LayoutPatternPanel`，匹配 `data-layout-pattern-root`。
- [x] 参数面板支持 `gap/padding/sidebarWidth/columns` 等通用参数。
- [x] 参数更新调用 `LayoutPatternRegistry.update`，批量回写子树。
- [x] 更新后保持当前选中节点稳定（必要时回退到 root 节点）。

主要文件：

- `apps/web/src/editor/features/design/inspector/panels/LayoutPatternPanel.tsx`（新增）
- `apps/web/src/editor/features/design/inspector/panels/registry.ts`（修改）
- `apps/web/src/editor/features/design/BlueprintEditorInspector.controller.ts`（必要时修改选中回写逻辑）

---

### Phase 3：内置组件 Meta Store 与通用 Props 面板

- [ ] 新增 `BuiltInMetaStore`（以 `runtimeType` 为 key）。
- [ ] 为首批内置组件补齐元数据（`MdrDiv/MdrSection/MdrCard/MdrPanel`）。
- [ ] 抽象通用 props 渲染器（复用外部组件字段渲染能力）。
- [ ] 在 Basic/Style 区块中按优先级渲染内置字段。

主要文件：

- `apps/web/src/editor/features/design/inspector/meta/builtInMetaStore.ts`（新增）
- `apps/web/src/editor/features/design/inspector/meta/builtInMeta.layout.ts`（新增）
- `apps/web/src/editor/features/design/inspector/sections/basic/InspectorComponentPropsFields.tsx`（新增）
- `apps/web/src/editor/features/design/inspector/sections/basic/InspectorExternalPropsFields.tsx`（重构或合并）
- `apps/web/src/editor/features/design/BlueprintEditorInspector.controller.ts`（新增 builtIn meta resolve）

---

### Phase 4：Schema 生成器（可选但推荐）

- [ ] 基于 `@mdr/ui` Props 定义生成基础 schema（union 枚举、基础类型、默认值）。
- [ ] 支持 JSDoc 标记覆盖（控件类型、分组、排序、隐藏规则）。
- [ ] 生成结果写入静态快照文件，供运行时读取。

主要文件：

- `scripts/generate-builtin-inspector-schema.mjs`（新增）
- `apps/web/src/editor/features/design/inspector/meta/generated/builtInSchema.json`（新增，产物）
- `package.json`（新增 script，可选）

---

### Phase 5：收敛与测试

- [ ] 将 `LayoutPanel` 中可 schema 化字段迁移到 meta 驱动。
- [ ] 保留复杂交互（如 margin/padding 四边联动）在专用面板中。
- [ ] 覆盖单测：范式插入、参数回写、字段渲染、回退策略。
- [ ] 补齐 i18n 文案（布局范式名称、字段标签、提示语）。

主要文件：

- `apps/web/src/editor/features/design/__tests__/BlueprintEditor.palette.test.tsx`（扩展）
- `apps/web/src/editor/features/design/__tests__/BlueprintEditorInspector.layout.test.tsx`（扩展）
- `apps/web/src/i18n/resources/zh-CN.json`（扩展）
- `apps/web/src/i18n/resources/en-US.json`（扩展，若存在）

## 与现有系统冲突评估

结论：**无硬冲突，但存在可控耦合点**。按上述分阶段实施可规避风险。

### 1) 与 MIR 契约（v1.2）

- 冲突级别：低
- 原因：范式元信息写入 `props.dataAttributes`，不改 MIR 顶层结构。
- 约束：`dataAttributes` 值统一字符串，避免序列化差异。

### 2) 与 Renderer Registry（内置/外部组件注册）

- 冲突级别：低
- 原因：范式仅生成普通节点，不新增渲染类型；内置 meta 与 runtime registry 解耦。
- 风险点：不要复用 external `metaStore` 的 key 空间，防止覆盖。

### 3) 与 Inspector 面板体系

- 冲突级别：中
- 原因：可能出现同字段重复渲染（`LayoutPanel` vs 新 schema 字段）。
- 规避：通过字段来源优先级与 gating 规则（面板互斥/隐藏）控制。

### 4) 与拖拽/树编辑/选中状态

- 冲突级别：中
- 原因：范式参数更新是“子树批量修改”，可能影响当前选中节点 id 或路径。
- 规避：`update()` 保持 id 稳定；若节点被删，自动回退选择范式 root。

### 5) 与命令历史/自动保存

- 冲突级别：低
- 原因：只要继续走 `updateMirDoc`，不会破坏 undo/redo 与 autosave 链路。
- 规避：禁止旁路更新（直接 mutate store 对象）。

### 6) 与外部组件 d.ts 推断系统

- 冲突级别：低
- 原因：内置走 BuiltIn Meta，外部走 External Meta，来源不同但 UI 可复用。
- 规避：统一渲染器接口，分开数据源，避免逻辑分叉。

## 非目标

1. 本决策不引入新的 MIR 文档类型。
2. 本决策不改变 `@mdr/ui` 组件渲染协议。
3. 本阶段不实现“强约束模板锁定”（用户仍可自由拆改节点）。

## 验收标准（Draft）

- [ ] 可在 Palette 中一键插入至少 3 种布局范式。
- [ ] 选中范式根节点可通过 Inspector 参数化调整布局并稳定回写。
- [ ] 内置布局组件调节项至少 70% 由 schema 驱动，不依赖硬编码面板。
- [ ] 不影响现有外部组件 d.ts 推断调节项能力。
- [ ] 现有 Blueprint 保存、刷新恢复、导出流程保持兼容。
