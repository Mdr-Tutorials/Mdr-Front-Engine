# Intent/Command 可扩展协议

## 状态

- Draft-Frozen（API-002）
- 日期：2026-02-08
- 冻结批次：`API-002`

## 决策背景

当前 API 与命令草案存在两类扩展瓶颈：

1. Intent 类型为固定枚举，新增功能需要频繁修改核心协议
2. Command 主要以函数式 `do/undo` 描述，不利于持久化、跨端重放、插件扩展

随着插件系统、自定义节点、AI 自动化、外部集成加入，固定枚举会成为演进阻力。

## 决策内容

引入 **命名空间 + 版本化 Envelope** 协议：

1. Intent 使用 `namespace/type/version/payload` 结构
2. Command 使用可序列化“操作描述”而非闭包函数
3. 核心域与插件域统一走同一协议
4. 未识别能力通过协商与降级策略处理

## Intent Envelope（Frozen v1）

```ts
type IntentEnvelope = {
  id: string;
  namespace: 'core' | 'plugin' | string; // e.g. "plugin.analytics"
  type: string; // e.g. "route.create"
  version: string; // e.g. "1.0"
  payload: Record<string, unknown>;
  idempotencyKey?: string;
  actor?: { userId?: string; clientId?: string };
  issuedAt: string;
};
```

## Command Envelope（Frozen v1）

```ts
type CommandEnvelope = {
  id: string;
  namespace: string;
  type: string;
  version: string;
  issuedAt: string;
  forwardOps: Array<PatchOp>;
  reverseOps: Array<PatchOp>;
  target: {
    workspaceId: string;
    documentId?: string;
  };
  mergeKey?: string;
};
```

`PatchOp` 建议采用受限 JSON Patch 子集，禁止任意脚本执行。

## 冻结字段规则（API-002）

### IntentEnvelope（required）

1. `id`
2. `namespace`
3. `type`
4. `version`
5. `payload`
6. `issuedAt`

### CommandEnvelope（required）

1. `id`
2. `namespace`
3. `type`
4. `version`
5. `issuedAt`
6. `forwardOps`
7. `reverseOps`
8. `target.workspaceId`

冻结窗口允许：

1. 新增可选字段（不得改变既有字段语义）
2. 扩展新 `namespace/type/version`

冻结窗口禁止：

1. 删除或重命名 required 字段
2. 改写 `forwardOps/reverseOps` 可逆语义
3. 将 envelope 回退为闭包式 do/undo 协议

## 能力协商

客户端启动时获取服务端能力：

```json
{
  "capabilities": {
    "core.route.create@1.0": true,
    "plugin.analytics.track@1.0": false
  }
}
```

规则：

1. 客户端发送前检查能力
2. 服务端对未知 `namespace/type/version` 返回 `UNSUPPORTED_INTENT`
3. 可选降级（如用基础意图组合实现）

## 与插件系统的关系

1. 插件仅能注册自己的 `namespace`
2. 插件意图需声明所需权限（见 ADR 14）
3. 核心域保留稳定兼容承诺，插件域允许更快迭代

## 未来编辑域预留（不实现 UI）

为避免后续重构，先预留核心命名空间（本期仅协议占位）：

1. `core.nodegraph.*`
2. `core.animation.*`

示例（占位）：

```txt
core.nodegraph.node.move@1.0
core.nodegraph.edge.connect@1.0
core.animation.timeline.keyframe.add@1.0
core.animation.clip.bind@1.0
```

约束：

1. 本期仅允许能力协商中出现，不要求前端实现对应编辑器
2. 若客户端收到相关命令，默认忽略并记录为 `UNHANDLED_RESERVED_DOMAIN`
3. 服务端可按能力返回 false，确保行为可预期

## 保留域错误码冻结（API-002）

服务端错误码（结构化返回）：

1. `UNSUPPORTED_INTENT`：未知或未启用的 intent 协议
2. `UNSUPPORTED_COMMAND`：未知或未启用的 command 协议
3. `RESERVED_DOMAIN_DISABLED`：命中保留域且 capability 为 `false`
4. `INVALID_ENVELOPE_VERSION`：版本不在支持窗口
5. `INVALID_ENVELOPE_PAYLOAD`：payload 校验失败

客户端状态码（本地处理）：

1. `UNHANDLED_RESERVED_DOMAIN`：保留域命令被 no-op 忽略并记录

## 风险与缓解

1. **风险：协议变得抽象，调试困难**
   - 缓解：提供 intent/command inspector（可视化 envelope）
2. **风险：插件滥用命名空间**
   - 缓解：命名空间注册与签名校验
3. **风险：回放时版本不兼容**
   - 缓解：保留版本转换器与最小支持窗口

## 验收标准（Draft）

- [ ] 新增一个核心意图无需改动旧枚举
- [ ] 插件可注册并执行独立命名空间意图
- [ ] Command 日志可序列化存储与重放
- [ ] 未支持意图能返回结构化错误并可降级
