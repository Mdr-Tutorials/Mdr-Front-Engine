# Revision 分区策略（Workspace/Document/Route）

## 状态

- Draft
- 日期：2026-02-08

## 决策背景

当前草案若使用单一 `workspaceRev` 作为并发控制锚点，该设计在单用户、低并发下可用，但在以下场景会快速退化：

1. 高频局部编辑（单页面改文案）与结构编辑（改路由）互相冲突
2. 离线队列重放时，一处局部更新可能被无关修改阻断
3. 未来实时协作中冲突粒度过粗，用户体验差

## 决策内容

采用 **分区 revision**：

1. `workspaceRev`：仅跟踪工作区结构层（路由清单、模块挂载、文档树关系）
2. `document.contentRev`：仅跟踪该文档内容
3. `document.metaRev`：文档名称/标签/逻辑归属等元信息
4. `routeRev`：路由清单逻辑版本（独立于文档内容）
5. `opSeq`：全局单调操作序号（审计/回放）

## 写入规则

### 文档内容保存

- 校验 `expectedContentRev`
- 成功后仅递增该文档 `contentRev`
- 不递增 `workspaceRev`（除非写入伴随结构变更）

### 路由/结构意图

- 校验 `expectedWorkspaceRev` 与（如涉及）`expectedRouteRev`
- 成功后递增 `workspaceRev` 与 `routeRev`
- 若自动创建/删除文档，相关文档 `metaRev` 递增

### 混合事务（如“拆分为布局+页面”）

- 单事务提交，原子更新多分区 rev
- 响应返回受影响 rev 集合

## API 响应最小集（建议）

```json
{
  "workspaceId": "ws_1",
  "workspaceRev": 18,
  "routeRev": 9,
  "updatedDocuments": [{ "id": "doc_home", "contentRev": 23, "metaRev": 4 }],
  "opSeq": 1284
}
```

## 冲突分类

1. `DOCUMENT_CONFLICT`：文档内容基线过期
2. `WORKSPACE_CONFLICT`：结构基线过期
3. `ROUTE_CONFLICT`：路由基线过期
4. `HYBRID_CONFLICT`：混合事务中的多分区冲突

## 为什么不是直接上 CRDT

1. 当前阶段主要解决单用户/轻协作一致性
2. 分区 rev 可以显著降低无意义冲突
3. 后续 CRDT 可在文档内容层渐进接入，不推翻结构层协议

## 对未来功能的扩展价值

1. 支持多人协作最小冲突域
2. 支持离线增量同步与精准重放
3. 支持审计时间轴与可解释冲突提示

## 风险与缓解

1. **风险：rev 维度变多，客户端实现复杂**
   - 缓解：SDK 封装 compare-and-set 逻辑
2. **风险：事务跨分区处理不一致**
   - 缓解：服务端统一事务层，禁止前端拆分提交
3. **风险：老接口兼容困难**
   - 缓解：明确全量切换窗口，停止单 `mir` 写入

## 验收标准（Draft）

- [ ] 单文档高频编辑不因无关路由变更产生冲突
- [ ] 路由编辑不阻塞其他文档保存
- [ ] 冲突响应可明确指出冲突分区与对象
- [ ] 批量事务可原子更新多分区 rev
