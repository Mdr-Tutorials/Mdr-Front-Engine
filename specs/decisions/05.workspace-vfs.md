# 引入 Workspace VFS（逻辑文件树）

## 状态

- Draft
- 日期：2026-02-08

## 决策背景

当前编辑器已经具备 MIR 的创建、编辑、渲染与导出闭环，但数据模型仍是单文档形态：

- 前端只有单一 `mirDoc`：`apps/web/src/editor/store/useEditorStore.ts`
- 自动保存是整份 MIR 覆盖：`apps/web/src/editor/features/design/BlueprintEditor.tsx`
- 路由地址目前是 Blueprint 本地状态，不是持久化工作区结构：`apps/web/src/editor/features/design/BlueprintEditor.tsx`

随着以下需求进入开发计划，单文档模型会成为核心瓶颈：

1. Node Graph 编辑器引入后会产生非 MIR UI 操作状态（节点位置、缩放、分组）
2. 需要在一个项目中管理多个页面/组件文档
3. 需要支持路由与布局的多文档组合

## 决策内容

引入 **Workspace VFS（Virtual File System）**，但限定为“逻辑文件树”而非浏览器级完整文件系统：

1. 浏览器侧维护 `workspace` 内存模型（文档树、文档内容、路由清单、活动文档）
2. 后端存储权威工作区快照（可分文档提交）
3. VFS 与路由显式解耦：路径不直接等于文件路径
4. VFS 为内部模型，不向用户暴露“文件树编辑器”

## 用户操作边界

用户只操作 Blueprint 里可见的页面结构与组件结构，不直接操作虚拟文件树。

1. 用户行为：新增路由、拆分布局、编辑页面、绑定事件
2. 系统行为：根据用户行为自动创建/移动/合并内部文档节点
3. UI 原则：不出现“手动重命名 `*.mir.json`”这类文件系统动作

## 方案对比

### 方案 A：继续单 `mirDoc`

- 优点：实现快
- 缺点：无法承载多文档、文件树、跨文档 Undo/Redo，后续重构成本极高

### 方案 B：浏览器完整 FS 模拟（POSIX 风格）

- 优点：概念统一
- 缺点：实现复杂度高，权限/持久化/同步成本高，超出当前阶段需求

### 方案 C：Workspace 逻辑 VFS（本决策）

- 优点：实现成本可控、与产品能力匹配、便于增量迁移
- 缺点：需要设计额外映射层（路由 <-> 文档）

## 目标数据结构（摘要）

```ts
type WorkspaceId = string;
type DocumentId = string;

type Workspace = {
    id: WorkspaceId;
    name: string;
    workspaceRev: number;
    routeRev: number;
    opSeq: number;
    treeRootId: string;
    treeById: Record<string, VfsNode>;
    docsById: Record<DocumentId, WorkspaceDocument>;
    routeManifest: RouteManifest;
    activeDocumentId: DocumentId;
};
```

## 不在本阶段做的事情

1. 不实现完整 POSIX API（chmod、symlink、watcher 等）
2. 不实现 CRDT 协同编辑
3. 不实现二进制大文件资产管线（后续单独 ADR）
4. 不实现 NodeGraph/动画编辑器 UI（仅预留文档类型与命令协议）

## 重构策略（Full Refactor）

不保留 `mirDoc` 兼容层，直接切换到 workspace 模型：

### 第一步：切换前端状态模型

1. 从 store 移除 `mirDoc/setMirDoc/updateMirDoc`
2. 全量改造为 `workspace + activeDocumentId + applyCommand`
3. Blueprint/Inspector/Export 同步改为“基于活动文档”访问

### 第二步：切换后端存储模型

1. 项目读取返回 `workspace` 快照而非单 `mir`
2. 保存接口改为文档级与工作区级写入
3. 迁移脚本将既有 `projects.mir_json` 转换为默认 workspace 结构

### 第三步：移除旧链路

1. 下线 `PUT /projects/:id/mir`
2. 下线依赖单文档结构的前端调用
3. CI 中禁止新增 `state.mirDoc` 引用

## 风险与缓解

1. **风险：编辑器模块耦合单文档假设**
    - 缓解：按模块分批重构并设置编译闸门，确保每阶段可运行
2. **风险：路由拆分设计过早定型**
    - 缓解：路由清单单独版本化，允许增量演进
3. **风险：性能回退**
    - 缓解：文档按需加载 + 结构缓存 + 精细订阅（Zustand selector）
4. **风险：全量重构窗口内功能不稳定**
    - 缓解：按模块分支推进 + 每阶段可运行验收门槛

## 验收标准（Draft）

- [ ] 一个项目可稳定管理 10+ MIR 文档
- [ ] Blueprint 可在不同页面/布局间切换并保持各自状态
- [ ] 不破坏现有保存与导出链路
- [ ] 用户全程无需接触虚拟文件树操作
