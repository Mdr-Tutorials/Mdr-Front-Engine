# MIR 契约统一与保存校验

## 状态

- Draft
- 日期：2026-02-08

## 决策背景

当前 MIR 在类型与校验层存在分叉风险：

1. 运行时主类型：`apps/web/src/core/types/engine.types.ts`
2. 生成类型：`packages/shared/src/types/mir.ts`
3. 后端保存仅做 JSON 规范化，不做 Schema 校验：`apps/backend/project_store.go`

当进入多文档与路由组合阶段，契约分叉会放大为运行时错误与导出不一致。

## 决策内容

建立 **单一 MIR 契约来源 + 双端校验**：

1. 统一维护 MIR Schema（v1.1）作为唯一真源
2. 前端/共享包/后端类型由 Schema 生成
3. 后端保存时强制校验；前端可在保存前做快速校验
4. 采用“读兼容、写统一”的版本迁移策略
5. 为插件/实验字段保留扩展命名空间，避免核心契约污染

## 契约策略

1. Schema 文件位置：`specs/mir/MIR-v1.1.json`（正式版）
2. Draft 期间说明文档：`specs/mir/mir-contract-v1.1.md`
3. 每次变更需附 ADR 或变更记录，禁止无版本号漂移
4. 扩展字段建议使用 `x-<namespace>` 命名约定并受权限治理

## 版本与兼容

1. `version` 字段语义化：`1.0`, `1.1`
2. 读取链路兼容旧字段（例如旧事件结构）
3. 写入链路输出当前稳定版本字段
4. 导出链路默认使用最新稳定版本

## 校验接入点

### 前端

- 编辑时轻量校验（可关闭）
- 发布/导出前强校验

### 后端

- `create` 与 `save` 请求必校验
- 返回结构化错误（路径、错误码、消息）

## 迁移策略

1. 先补齐 v1.1 草案字段与映射器
2. 在后端加“校验可观测”日志（灰度）
3. 再启用强校验并开放回退开关

## 风险与缓解

1. **风险：严格校验导致历史项目无法保存**
   - 缓解：读时自动迁移 + 错误修复建议
2. **风险：生成类型与手写类型冲突**
   - 缓解：禁止手写核心 MIR 类型，统一由脚本生成
3. **风险：Schema 演进过快**
   - 缓解：版本冻结窗口 + 兼容性测试

## 验收标准（Draft）

- [ ] 前后端都基于同一 MIR Schema 版本
- [ ] 保存接口可返回可读的字段级校验错误
- [ ] 旧项目可自动迁移并成功保存
- [ ] 导出链路与运行时渲染对同一 MIR 结果一致
