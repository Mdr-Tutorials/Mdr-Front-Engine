# Route Runtime Contract（Loader/Meta/Error/Guard）

## 状态

- Draft
- 日期：2026-02-08

## 决策背景

当前 Route Manifest 草案主要覆盖路径匹配与 layout/page 组合，但对运行时能力定义不足。未来功能（SSR/SEO/A-B/监控/鉴权）需要在路由层有稳定承载点。

若继续以“仅路径+文档引用”演进，后续会频繁破坏路由结构。

## 决策内容

在 RouteNode 上引入运行时契约字段，形成“可匹配 + 可执行 + 可观测”的路由定义。

## RouteNode Runtime 扩展（Draft）

```ts
type RouteRuntime = {
  loaderRef?: string; // 数据加载器（命名引用）
  actionRef?: string; // 表单/变更动作
  guardRef?: string; // 访问控制
  errorBoundaryDocId?: string; // 错误页面
  suspenseDocId?: string; // 加载态页面
  seo?: {
    title?: string;
    description?: string;
    canonical?: string;
    noIndex?: boolean;
    openGraph?: Record<string, string>;
  };
  experiment?: {
    key: string; // A/B 实验 key
    variantMap?: Record<string, string>; // variant -> pageDocId
  };
};
```

`RouteNode` 包含 `runtime?: RouteRuntime`。

## 执行顺序（建议）

1. 路由匹配得到 `matchChain`
2. 执行 `guardRef`（从根到叶）
3. 并行/串行执行 `loaderRef`（按策略）
4. 组装 layout + page + Outlet
5. 处理 `actionRef`（提交类事件）
6. 应用 SEO 元数据

异常处理：

- 任一节点异常优先命中最近 `errorBoundaryDocId`

## 与 Blueprint 的关系

1. 用户仍只操作可视化路由与页面
2. 运行时配置通过“高级面板”填写，不暴露底层 VFS
3. loader/guard/action 使用引用机制，避免内嵌不可控脚本

## 风险与缓解

1. **风险：运行时字段过多导致学习负担**
   - 缓解：分层显示（基础/高级）
2. **风险：跨框架语义不一致**
   - 缓解：定义框架无关中间契约，导出时适配
3. **风险：A/B 与 SEO 配置冲突**
   - 缓解：规则校验 + 发布前静态检查

## 验收标准（Draft）

- [ ] 路由可声明并执行 loader/guard
- [ ] 错误边界可按层级兜底
- [ ] SEO 字段可从路由配置输出到构建产物
- [ ] A/B 变体可在路由层受控切换
