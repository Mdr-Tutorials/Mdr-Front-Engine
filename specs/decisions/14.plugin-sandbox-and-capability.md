# 插件沙箱与能力权限模型

## 状态

- Draft
- 日期：2026-02-08

## 决策背景

未来规划涉及插件市场、自定义节点、第三方 API 集成。若插件可直接访问宿主全量能力，将引入安全与稳定性风险：

1. 非授权数据访问（项目内容、用户信息）
2. 任意网络请求与隐私泄露
3. 插件崩溃拖垮编辑器主线程

## 决策内容

采用 **Capability-based Sandbox**：

1. 插件运行在隔离上下文（Worker/iframe）
2. 插件通过声明能力（capabilities）申请权限
3. 宿主按最小权限原则授权
4. 所有敏感操作经宿主网关执行并审计

## 能力清单（初版）

```txt
workspace.read
workspace.intent.dispatch
document.read:<scope>
document.write:<scope>
route.read
route.intent.dispatch
network.request:<allowlist-id>
secrets.read:<secret-scope>
ui.panel.register
telemetry.emit
```

## 插件清单（Draft）

```json
{
  "id": "plugin.analytics",
  "version": "0.1.0",
  "entry": "dist/index.js",
  "capabilities": [
    "workspace.read",
    "workspace.intent.dispatch",
    "network.request:analytics-default"
  ]
}
```

## 授权模型

1. 安装时显示权限摘要
2. 高风险能力（`network.request`、`secrets.read`）需显式确认
3. 企业模式支持管理员策略（allow/deny list）
4. 运行时可撤销授权

## 运行时隔离

1. 插件不得直接访问 DOM 全局对象
2. 插件与宿主通过消息通道通信
3. 每个插件有资源配额（CPU 时间、内存、消息速率）
4. 超限触发熔断与降级

## 审计与可观测

1. 记录插件触发的 intent 与网络请求摘要
2. 支持审计导出（时间、插件、能力、结果）
3. 异常率与超时率进入健康评分

## 风险与缓解

1. **风险：权限弹窗过多影响体验**
   - 缓解：分组授权 + 模板策略
2. **风险：沙箱通信性能损耗**
   - 缓解：批量消息与只读快照缓存
3. **风险：恶意插件绕过限制**
   - 缓解：签名校验、内容哈希、策略拦截与市场审核

## 验收标准（Draft）

- [ ] 插件无法越权读写工作区数据
- [ ] 网络请求仅可访问授权域名
- [ ] 插件崩溃不影响主编辑器可用性
- [ ] 审计日志可追踪插件关键行为

