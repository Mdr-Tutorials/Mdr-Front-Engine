# 样式协议编辑器（Class Protocol Editor）决策

## 状态

- Draft
- 日期：2026-02-14

## 决策背景

当前 Inspector 的类名编辑能力偏基础，难以支撑工业级效率场景：

1. 缺少键盘优先的高密度编辑能力（Token/Inline 双模、批量粘贴解析、冲突提示）。
2. 缺少 Tailwind/UnoCSS 的智能补全与上下文排序，用户需要在记忆负担下手写类名。
3. 不能牺牲传统 CSS class 工作流，必须支持“任意类名 + 可跳转挂载 CSS 文件”。
4. 需要与 MIR 保持稳定映射，避免把编辑器内部态直接污染运行时协议。

## 决策内容

采用“**传统 className 为事实源 + 可插拔智能引擎**”的分层方案：

1. **事实源不变**：组件样式主字段仍为 `props.className`（字符串，空格分隔）。
2. **编辑协议升级**：Inspector 内部将输入解析为 Token 流进行编辑与校验，但提交时回写为规范化字符串。
3. **引擎可插拔**：Tailwind、UnoCSS、Native CSS 作为并行能力引擎，统一接入建议、冲突检测、可视化信息。
4. **传统 CSS 一等公民**：未知类名不报错不阻断，标记为“外部类名”并允许完整保留。
5. **挂载 CSS 跳转**：若组件已挂载样式文件，提供“打开挂载 CSS”动作，直接切到代码编辑器并定位目标文件。

## 架构约束

### 1) 协议层（MIR）

1. Phase 1 不修改 MIR 基础契约：仅持久化 `props.className`。
2. 智能建议、冲突组、排序权重、幽灵预览均属于编辑器临时状态，不入库。
3. 需要可逆：从 `props.className` 可无损重建 Token 列表（含 unknown token）。

### 2) 引擎层（Suggestion/Validation Engine）

统一引擎接口（逻辑约束，不限定实现）：

1. `tokenize(input)`：字符串 -> Token 流。
2. `suggest(context)`：返回按场景排序的候选（Layout/Spacing/Typography/Effects/Interactivity）。
3. `resolveConflict(tokens)`：冲突检测与置换建议（如 `p-4` vs `p-6`）。
4. `explain(token)`：提供颜色/尺寸/语义描述，用于视觉提示。

引擎优先级：

1. 项目启用 Tailwind 时，Tailwind 引擎优先。
2. 项目启用 UnoCSS 时，Uno 引擎并行参与建议。
3. Native CSS 引擎始终兜底，保证未知类名可输入、可保存、可渲染。

### 3) 交互层（Intelligent UX）

必须满足以下体验承诺：

1. **双模编辑**：Token 模式（整块操作）+ Inline 模式（局部改写）。
2. **键盘覆盖**：方向键导航、Enter 提交、Backspace 删除 Token、粘贴自动拆词。
3. **视觉线索**：颜色 Swatch、布局图标、数值换算提示（如 `w-64 -> 16rem / 256px`）。
4. **上下文排序**：根据现有类名预测相关候选（如有 `flex` 则优先 `flex-col/items-*`）。
5. **幽灵预览**：输入中间态可在画布试渲染，失焦/取消后回滚，不写入 MIR。

## CSS 挂载跳转决策

1. 组件存在“挂载 CSS”元信息时，Inspector 显示“编辑挂载 CSS”入口。
2. 触发后执行统一命令链路：`Inspector Action -> Workspace OpenDocument -> CodeEditor Focus`。
3. 若无法定位文件，给出非阻断提示并保留当前 class 编辑流程。
4. 此能力与 Tailwind/Uno 无耦合，适用于任意传统样式文件。

## 非目标

1. 本阶段不做完整静态 CSS 依赖图分析。
2. 不要求一次性覆盖 Tailwind/Uno 全量语法边界。
3. 不在本决策内定义 NodeGraph/动画编辑器的样式编辑 UI。

## 分阶段落地

### Phase 1：协议统一与兼容优先

1. 建立 Token 化编辑器，但仅回写 `props.className`。
2. 支持 unknown token 保留与 class 粘贴解析。
3. 打通“编辑挂载 CSS”跳转能力。

### Phase 2：智能建议与冲突处理

1. 接入 Tailwind/Uno 引擎候选与冲突组。
2. 完成分组排序和上下文推荐。
3. 增加非法/外部类名视觉标记（非报错）。

### Phase 3：高阶交互与性能

1. 双模编辑 + 全键盘交互完善。
2. 视觉预览与幽灵渲染联动画布。
3. 搜索反馈目标控制在 16ms 级别。

## 验收标准（Draft）

- [ ] 任何 class 字符串可无损读写，未知类名不丢失。
- [ ] Tailwind/Uno 建议可插拔启停，不影响基础 class 编辑。
- [ ] 组件可从 Inspector 一键跳转到挂载 CSS 文件并打开代码编辑器。
- [ ] 幽灵预览不污染 MIR 持久化数据。
- [ ] 键盘主路径可完成新增、修改、删除类名 Token。
