# NodeGraph Port 语义与连线约束决策

## 状态

- Draft
- 日期：2026-02-19
- 执行规范：
  - `specs/implementation/node-graph-control-flow-ui-spec.md`

## 决策背景

当前 NodeGraph 已具备基础连线与右键交互，但 Port 语义仍存在潜在漂移风险：

1. 端口形状与数据语义未形成“硬约束”规范，不同节点可能各自定义。
2. 多连接能力（single/multi）有事实行为，但缺少统一默认策略。
3. 右键交互中是否需要“已占用”提示存在分歧，可能造成重复噪音反馈。
4. 未来节点类型扩展（控制流、数据流、分支类节点）需要稳定的兼容底座。

## 目标

1. 固化 Port 视觉语义（形状 + 实心/空心）与连接语义（类别匹配）。
2. 固化各类别 Port 的默认 multiplicity 策略，并允许节点级覆写。
3. 明确“占用场景”的交互行为：以连线结果为准，不增加冗余提示。
4. 确保规范可直接映射到现有 Canvas 渲染与 `graphState` 连接校验流程。

## 决策内容

### 1) Port 视觉语义

1. `control` 使用圆形端口。
2. `data` 使用方形端口。
3. `node`（分支/节点类语义）使用菱形端口。
4. `out` 端口为实心，`in` 端口为空心。
5. `multiplicity=multi` 保持灰色外圈/边框强调；`single` 不显示外圈。

说明：若实现层仍使用 `condition` 作为内部 kind，可在渲染层映射到 `node` 语义，不改变视觉契约。

### 2) 连线约束

1. 只允许 `out -> in`。
2. 只允许同类别连接：
   - `control -> control`
   - `data -> data`
   - `node -> node`
3. 默认禁止跨类别连接；跨类别白名单仅允许通过节点级 `acceptsKinds` 显式声明。

### 3) 默认 multiplicity 策略

默认规则如下（节点可覆写）：

1. 控制流：`control.out=single`，`control.in=multi`。
2. 数据流：`data.out=multi`，`data.in=single`。
3. 节点类：`node.in=single`，`node.out=multi`。

### 4) 占用与替换策略

当单连接端口再次建立连接时，采用“后连覆盖前连”：

1. `source` 为 `single`：移除同 source port 旧连线，再写新连线。
2. `target` 为 `single`：移除同 target port 旧连线，再写新连线。
3. 双方均为 `single` 时，同时执行以上规则。

该策略与当前 `upsertEdge` 行为保持一致，且不引入阻断式报错。

### 5) 右键交互决策

1. 不展示“端口已占用”提示项（包括右键菜单项与 toast）。
2. 端口状态由连线可视结果表达（线是否已存在、是否替换成功）。
3. `Create Node` 是否显示仅由“是否可新增连接”决定，不展示占用原因文案。
4. `Disconnect` 继续保留，用于移除该端口相关连线。

## 数据契约建议（规范层）

```ts
type PortKind = 'control' | 'data' | 'node';
type PortRole = 'in' | 'out';
type PortMultiplicity = 'single' | 'multi';

type NodeGraphPort = {
  id: string;
  role: PortRole;
  kind: PortKind;
  multiplicity?: PortMultiplicity;
  acceptsKinds?: PortKind[];
  shape?: 'circle' | 'square' | 'diamond';
};
```

约束：

1. `shape` 缺省时由 `kind` 推导，不建议业务层手工覆盖。
2. `acceptsKinds` 缺省时等于自身 `kind`。
3. `slotOrder` 仍为端口稳定排序依据，不参与类别判定。

## 标准调用链路

`Node Type -> resolveNodeDefaultPorts -> Canvas Renderer(shape/fill/multi-ring) -> Interaction(hit/drag) -> upsertEdge(compat + multiplicity replacement) -> Graph Context Menu(gated actions)`

## 与现有实现的一致性要求

1. 渲染层：
   - 圆/方/菱 + 实心/空心必须可直接从 `port.kind + port.role` 推导。
2. 状态层：
   - `isConnectionCompatible` 必须以“同 kind + out->in”为默认规则。
3. 菜单层：
   - 禁止新增“已占用”提示菜单项。
4. 序列化层：
   - 历史图数据应可通过 normalize 自动补齐缺省 multiplicity 与 shape。

## 非目标

1. 不定义节点业务执行语义（executeGraph/runtime patch 等）。
2. 不定义主题色 token（仅约束形状与填充语义）。
3. 不引入跨类别自动转换器（例如 data 自动转 control）。

## 验收标准（Draft）

- [ ] 任意节点图中，端口视觉可由类别和方向唯一判断（无文案依赖）。
- [ ] 跨类别连线在交互层被拒绝，不产生脏边数据。
- [ ] 单连接端口重复连线时，表现为稳定替换，不弹“已占用”提示。
- [ ] 右键菜单中 `Create Node` 与 `Disconnect` 的显示条件与连接能力一致。
